services:
  postgres:
    image: postgres:16
    environment:
      POSTGRES_USER: inneri
      POSTGRES_PASSWORD: inneri
      POSTGRES_DB: inneri
    ports:
      - "5432:5432"
    volumes:
      - ./db/schema.sql:/docker-entrypoint-initdb.d/01_schema.sql:ro
      - ./db/seed.sql:/docker-entrypoint-initdb.d/02_seed.sql:ro

  vault:
    image: hashicorp/vault:1.17
    environment:
      VAULT_DEV_ROOT_TOKEN_ID: inneri-root
      VAULT_DEV_LISTEN_ADDRESS: "0.0.0.0:8200"
      VAULT_ADDR: "http://127.0.0.1:8200"
    ports:
      - "8200:8200"
    cap_add:
      - IPC_LOCK
    volumes:
      - ./vault/init.sh:/init.sh:ro
    command: >
      sh -c "vault server -dev -dev-root-token-id=$$VAULT_DEV_ROOT_TOKEN_ID -dev-listen-address=$$VAULT_DEV_LISTEN_ADDRESS &
             sleep 2 &&
             export VAULT_ADDR=http://127.0.0.1:8200 &&
             vault login -no-print $$VAULT_DEV_ROOT_TOKEN_ID &&
             sh /init.sh &&
             wait"

  opa:
    image: openpolicyagent/opa:0.63.0
    command: ["run", "--server", "--log-level=info", "/policies/policy.rego"]
    ports:
      - "8181:8181"
    volumes:
      - ./policies/policy.rego:/policies/policy.rego:ro

  gateway:
    build: ./gateway
    environment:
      INNERI_DB_DSN: postgresql+psycopg://inneri:inneri@postgres:5432/inneri
      INNERI_OPA_URL: http://opa:8181
      INNERI_RECEIPT_SIGNING_KEY: dev_only_change_me
      INNERI_JWT_SIGNING_KEY: dev_jwt_change_me
      INNERI_VAULT_ADDR: http://vault:8200
      INNERI_VAULT_TOKEN: inneri-root
      INNERI_FAIL_OPEN: "false"
      INNERI_LOG_LEVEL: info
    ports:
      - "8080:8080"
    depends_on:
      - postgres
      - opa
      - vault
